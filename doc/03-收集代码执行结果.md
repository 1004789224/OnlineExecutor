# 收集代码执行结果



就像我们平时在不那么高级的 IDE 中编写代码一样，我们主要通过 `System.out` 来展示运行结果，异常信息也是直接打印到控制台来看的。所以我们要能以相同的方式让客户端可以得到他想要运行的代码的运行结果，这就需要我们将程序往标准输入（System.out）和标准输出（System.err）中打印的信息收集起来返回给客户端。

可是这就涉及到一个问题了，





Class 文件中常量的存储方式

- 从起始位置 0x00000008 开始向后取 2 个字节，可以得到常量池中常量的个数，假设有 cpc 个；

- 这 cpc 个常量按照以下方式进行存储：

	```java
	... [ tag ] [ 当前常量的长度 len ] [ 常量的符号引用的字符串值 ] ...
	... [ 1位 ] [        2位        ] [         len位         ] ...
	```

- 我们只需要遍历这 cpc 个常量，检查其中的 CONSTANT_UTF8_INFO（tag = 1）类型的常量的内容是不是 System，然后把它替换成我们的 HackSystem，实现劫持 System。





最后，我们还有一个小问题需要注意一下，问题是有关“换行符”的，在结果字符串中，换行是通过 `"\r\n"` 表示的，可是将结果返回给客户端，客户端是用 html 来展示结果的，因此我们需要将运行结果字符串中所有的 `"\r\n"` 都替换为 `<br/>`，我们在 RunCodeController 中添加如下一行代码完成这步操作：

```java
runResult = runResult.replaceAll("\r\n", "<br/>");
```

