# 收集代码执行结果



就像我们平时在不那么高级的 IDE 中编写代码一样，我们主要通过 `System.out` 来展示运行结果，异常信息也是直接打印到控制台来看的。所以我们要能以相同的方式让客户端可以得到他想要运行的代码的运行结果，这就需要我们将程序往标准输入（System.out）和标准输出（System.err）中打印的信息收集起来返回给客户端。

可是这就涉及到一个问题了，标准输出设备是整个虚拟机进程全局共享的资源，如果使用 `System.setOut()` / `System.setErr()` 方法把输出流重定向到自己定义的 PrintStream 对象上固然可以收集输出信息，但这在多线程的情况下显然是不可取的，因为既有可能将其他线程的结果也收集了。除此之外，还允许客户端程序随便调用 System 的方法还存在着安全隐患，比如如果客户端发来的程序中调用了：`System.exit(0)` 等方法，这对服务器来说是十分危险的，所以我们考虑将程序中的 System 都替换掉，替换成一个我们自己写的 HackSystem 类，这样既可以收集到客户端程序的运行结果，又可以将 System 中比较危险的调用都改写成抛出异常，以达到禁止客户端程序调用的目的。

*注意：HackSystem 类收集客户端程序的运行结果的过程还涉及到一个并发问题，我们将在后面详细讲解 HackSystem 类时进行说明，这一节主要讲如何将客户端程序中对 System 的调用替换为对 HackSystem 的调用*



## 将 System 替换为 HackSystem 的思路

那么如何将客户端程序中对 System 的调用替换为对 HackSystem 的调用呢？当然不能直接修改客户端发来的程序的源代码字符串了，这既不优雅，操作也十分的繁琐。我们采用了一种“高级”的方法，即直接在字节码中，把要执行的类对 System 的符号引用替换为我们准备的 HackSystem 的符号引用，因此我们需要一个字节码修改器，这个字节码修改器完成如下流程：

- 遍历字节码中的所有符号引用，找到 "java/lang/System"；
- 将 "java/lang/System" 替换为 “.../HackSystem”。

要想完成以上 2 步操作，首先我们要了解类文件的结构，这样我们才能找到类对 System 的符号引用的位置，并且知道替换的方法；其次，我们还需要一个字节数组修改工具 ByteUtils 帮助我们修改存储字节码的字节数组。



## 类文件结构

这里，为了不影响阅读的流畅性，我们只简单介绍一下我们会用到的有关类文件结构的部分。

Class 文件是一组以 8 位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在 Class 文件中，中间没有任何分隔符。


Class 文件中常量的存储方式

- 从起始位置 0x00000008 开始向后取 2 个字节，可以得到常量池中常量的个数，假设有 cpc 个；

- 这 cpc 个常量按照以下方式进行存储：

	```java
	... [ tag ] [ 当前常量的长度 len ] [ 常量的符号引用的字符串值 ] ...
	... [ 1位 ] [        2位        ] [         len位         ] ...
	```

- 我们只需要遍历这 cpc 个常量，检查其中的 CONSTANT_UTF8_INFO（tag = 1）类型的常量的内容是不是 System，然后把它替换成我们的 HackSystem，实现劫持 System。


## ByteUtils 工具





## 实现字节码修改器







最后，我们还有一个小问题需要注意一下，问题是有关“换行符”的，在结果字符串中，换行是通过 `"\r\n"` 表示的，可是将结果返回给客户端，客户端是用 html 来展示结果的，因此我们需要将运行结果字符串中所有的 `"\r\n"` 都替换为 `<br/>`，我们在 RunCodeController 中添加如下一行代码完成这步操作：

```java
runResult = runResult.replaceAll("\r\n", "<br/>");
```

